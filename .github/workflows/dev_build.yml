name: Build and run tests (dev)

on:
  pull_request:
    branches: [ dev, pre-release/beta ]

jobs:

  frontend-develop:

    runs-on: ubuntu-latest

    steps:

    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: Install dependencies
      run: |
        cd $PWD/TokanPages.ClientApp
        npm install --global yarn
        yarn global add sonarqube-scanner
        yarn install

    - name: Test client application
      run: |
        cd $PWD/TokanPages.ClientApp
        yarn app-test --ci --coverage
        yarn sonar \
        -Dsonar.login=${{ secrets.SONARQUBE_TOKEN_FE }} \
        -Dsonar.projectName=${{ secrets.SONARQUBE_PROJECT_NAME_FE }} \
        -Dsonar.projectKey=${{ secrets.SONARQUBE_PROJECT_KEY_FE }} \
        -Dsonar.host.url=${{ secrets.SONARQUBE_HOST }}

  backend-develop:

    runs-on: ubuntu-latest

    env:
      TARGET_DIRECTORY: $PWD/sonarqubecoverage
      COVERAGE_REPORT: $PWD/*/*/TestResults/*/coverage.cobertura.xml
      SONAR_REPORT: SonarQube.xml

    steps:

    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Log to Azure Cloud
      uses: Azure/login@v2.1.0
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Get Azure Key Vault secrets
      uses: TomaszKandula/get-keyvault-secrets@v1.0.3
      with:
        keyvault: ${{ secrets.AZURE_KEY_VAULT }}
        secrets: ${{ secrets.AZURE_KEY_VAULT_LIST_TEST }}
      id: vault

    - name: Variable substitution appsettings file for Testing (.NET)
      uses: TomaszKandula/variable-substitution@v1.0.2
      with:
        files: ${{ github.workspace }}/TokanPages.Configuration/appsettings.Testing.json
      env:
        AppSettings__Email_PrivateKey: "${{ steps.vault.outputs.TestEmailPrivateKey }}"
        AppSettings__Email_HealthUrl: "${{ steps.vault.outputs.TestEmailHealthUrl }}"
        AppSettings__Email_BaseUrl: "${{ steps.vault.outputs.TestEmailBaseUrl }}"
        AppSettings__Email_Address_Admin: "${{ steps.vault.outputs.TestEmailAddressesAdmin }}"
        AppSettings__Email_Address_Contact: "${{ steps.vault.outputs.TestEmailAddressesContact }}"
        AppSettings__Email_Address_Support: "${{ steps.vault.outputs.TestEmailAddressesItSupport }}"
        AppSettings__Db_DatabaseContext: "${{ steps.vault.outputs.TestDbConnect }}"
        AppSettings__Db_DatabaseContext_Migrator: "${{ steps.vault.outputs.TestDbMigrator }}"
        AppSettings__AZ_Bus_ConnectionString: "${{ steps.vault.outputs.TestAzBusConnectionString }}"
        AppSettings__AZ_Storage_BaseUrl: "${{ steps.vault.outputs.TestAzStorageBaseUrl }}"
        AppSettings__AZ_Storage_ContainerName: "${{ steps.vault.outputs.TestAzStorageContainerName }}"
        AppSettings__AZ_Storage_ConnectionString: "${{ steps.vault.outputs.TestAzStorageConnectionString }}"
        AppSettings__AZ_Storage_MaxFileSizeUserMedia: "${{ steps.vault.outputs.TestAzStorageMaxFileSizeUserMedia }}"
        AppSettings__AZ_Storage_MaxFileSizeSingleAsset: "${{ steps.vault.outputs.TestAzStorageMaxFileSizeSingleAsset }}"
        AppSettings__AZ_Redis_InstanceName: "${{ steps.vault.outputs.TestAzRedisInstanceName }}"
        AppSettings__AZ_Redis_ConnectionString: "${{ steps.vault.outputs.TestAzRedisConnectionString }}"
        AppSettings__AZ_Redis_ExpirationMinute: "${{ steps.vault.outputs.TestAzRedisExpirationMinute }}"
        AppSettings__AZ_Redis_ExpirationSecond: "${{ steps.vault.outputs.TestAzRedisExpirationSecond }}"
        AppSettings__Paths_NewsletterUpdate: "${{ steps.vault.outputs.TestPathsUpdateSubscriber }}"
        AppSettings__Paths_NewsletterRemove: "${{ steps.vault.outputs.TestPathsUnsubscribe }}"
        AppSettings__Paths_UpdatePassword: "${{ steps.vault.outputs.TestPathsUpdatePassword }}"
        AppSettings__Paths_Activation: "${{ steps.vault.outputs.TestPathsActivation }}"
        AppSettings__Paths_DevelopmentOrigin: "${{ steps.vault.outputs.TestPathsDevelopmentOrigin }}"
        AppSettings__Paths_DeploymentOrigin: "${{ steps.vault.outputs.TestPathsDeploymentOrigin }}"
        AppSettings__Paths_Templates_Newsletter: "${{ steps.vault.outputs.TestPathsNewsletter }}"
        AppSettings__Paths_Templates_ContactForm: "${{ steps.vault.outputs.TestPathsContactForm }}"
        AppSettings__Paths_Templates_ResetPassword: "${{ steps.vault.outputs.TestPathsResetPassword }}"
        AppSettings__Paths_Templates_RegisterForm: "${{ steps.vault.outputs.TestPathsRegisterForm }}"
        AppSettings__Ids_Issuer: "${{ steps.vault.outputs.TestIdsIssuer }}"
        AppSettings__Ids_Audience: "${{ steps.vault.outputs.TestIdsAudience }}"
        AppSettings__Ids_WebSecret: "${{ steps.vault.outputs.TestIdsWebSecret }}"
        AppSettings__Ids_RequireHttps: "${{ steps.vault.outputs.TestIdsRequireHttps }}"
        AppSettings__Ids_WebToken_Maturity: "${{ steps.vault.outputs.TestIdsWebTokenMaturity }}"
        AppSettings__Ids_RefreshToken_Maturity: "${{ steps.vault.outputs.TestIdsRefreshTokenMaturity }}"
        AppSettings__Limit_Reset_Maturity: "${{ steps.vault.outputs.TestLimitsResetMaturity }}"
        AppSettings__Limit_Activation_Maturity: "${{ steps.vault.outputs.TestLimitsActivationMaturity }}"
        AppSettings__Limit_Likes_Anonymous: "${{ steps.vault.outputs.TestLimitsLikesAnonymous }}"
        AppSettings__Limit_Likes_User: "${{ steps.vault.outputs.TestLimitsLikesUser }}"

    - name: Setup dotnet
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Install dependencies
      run: dotnet restore TokanPages.slnx

    - name: SonarQube begin scan dotnet
      run: |
        dotnet tool install --global dotnet-sonarscanner --version 5.15.0
        dotnet tool update dotnet-reportgenerator-globaltool -g --version 5.3.11
        dotnet sonarscanner begin \
        /k:${{ secrets.SONARQUBE_PROJECT_KEY_BE }} \
        /n:${{ secrets.SONARQUBE_PROJECT_NAME_BE }} \
        /d:sonar.login=${{ secrets.SONARQUBE_TOKEN_BE }} \
        /d:sonar.host.url=${{ secrets.SONARQUBE_HOST }} \
        /d:sonar.coverageReportPaths="${{ env.TARGET_DIRECTORY }}/${{ env.SONAR_REPORT }}"

    - name: Build .NET
      run: dotnet build TokanPages.slnx

    - name: Test with the dotnet CLI
      run: |
        cd TokanPages.Tests/TokanPages.Tests.UnitTests
        ASPNETCORE_ENVIRONMENT=Testing dotnet test --no-build --collect:"XPlat Code Coverage"
        cd ../..
        mkdir "${{ env.TARGET_DIRECTORY }}"
        reportgenerator "-reports:${{ env.COVERAGE_REPORT }}" "-targetdir:${{ env.TARGET_DIRECTORY }}" "-reporttypes:SonarQube"
      env:
        ASPNETCORE_ENVIRONMENT: Testing

    - name: SonarQube end scan dotnet
      run: dotnet sonarscanner end /d:sonar.login=${{ secrets.SONARQUBE_TOKEN_BE }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
